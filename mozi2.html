<!DOCTYPE html>
<html>
<head>
<title>あたまおしりゲーム (カスタム対戦)</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #f4f4f9;
    padding: 20px;
    color: #333;
  }
  
  h2 {
    color: #1d3557;
    margin-bottom: 10px;
  }

  /* 設定エリア */
  #settingsArea {
    width: 80%;
    max-width: 500px;
    background-color: #fff;
    padding: 20px 25px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  .setting-group {
    margin-bottom: 15px;
  }
  .setting-group label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
  }
  #startButton {
    padding: 10px 30px;
    font-size: 18px;
    background-color: #e63946;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  #startButton:hover {
    background-color: #c9303c;
  }
  
  /* ゲーム情報エリア */
  #gameArea {
    display: none; /* 初期非表示 */
    width: 80%;
    max-width: 500px;
  }
  
  #turnIndicator {
    font-size: 24px;
    font-weight: bold;
    color: #e63946;
    margin-bottom: 10px;
    text-align: center;
  }

  #timerDisplay {
    font-size: 40px;
    font-weight: 900;
    color: #1d3557;
    margin-bottom: 10px;
    text-align: center;
  }

  #currentRule {
    font-size: 36px;
    font-weight: 900;
    color: #4895ef;
    margin: 15px 0;
    text-align: center;
    background-color: #f1faee;
    padding: 5px;
    border-radius: 5px;
  }
  
  /* スコアボード */
  #scoreBoard {
    display: flex;
    justify-content: space-around;
    width: 100%;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: bold;
  }

  .score-item {
    padding: 8px 15px;
    border-radius: 5px;
    background-color: #f1faee;
    border: 1px solid #a8dadc;
    flex: 1;
    margin: 0 5px;
    text-align: center;
  }

  /* 入力エリア */
  #inputArea {
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  
  #wordInput {
    padding: 10px;
    font-size: 16px;
    border: 2px solid #a8dadc;
    border-radius: 5px;
    flex-grow: 1;
  }

  #submitButton {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #1d3557;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  #submitButton:hover:not(:disabled) {
    background-color: #457b9d;
  }
  #submitButton:disabled {
    background-color: #ccc;
    cursor: default;
  }

  /* 履歴エリア */
  #historyArea {
    width: 100%;
    margin-top: 25px;
    text-align: left;
  }

  #historyList {
    list-style: none;
    padding: 0;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    background-color: #fff;
  }

  #historyList li {
    padding: 5px 0;
    border-bottom: 1px dotted #ccc;
    font-size: 16px;
  }
  
  #historyList li:last-child {
    border-bottom: none;
  }
  
  .player1-entry { color: #e63946; } 
  .player2-entry { color: #4895ef; } 
  
  .reset-button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    background-color: #a8dadc;
    color: #1d3557;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
</head>
<body>

  <h2>あたまおしりゲーム</h2>

  <div id="settingsArea">
    <div class="setting-group">
      <label for="roundsSelect">ラウンド数 (ターン数) 選択:</label>
      <select id="roundsSelect">
        <option value="5">5 ラウンド</option>
        <option value="10">10 ラウンド</option>
        <option value="15">15 ラウンド</option>
      </select>
    </div>
    <div class="setting-group">
      <label for="opponentSelect">対戦相手選択:</label>
      <select id="opponentSelect">
        <option value="cpu">CPU と対戦</option>
        <option value="human">2人で対戦 (人間 vs 人間)</option>
      </select>
    </div>
    <button id="startButton" onclick="startGame()">ゲームスタート</button>
  </div>

  <div id="gameArea">
    <div id="turnIndicator">ゲームを開始してください</div>
    <div id="timerDisplay">10</div>
    <div id="currentRule">？ → ？</div>
  
    <div id="scoreBoard">
      <div class="score-item">あなた (P1): <span id="playerScore">0</span></div>
      <div class="score-item"><span id="p2Label">CPU</span> (P2): <span id="cpuScore">0</span></div>
    </div>

    <div id="inputArea">
      <input type="text" id="wordInput" placeholder="言葉を入力 (ひらがな/カタカナ)">
      <button id="submitButton" onclick="submitWord()">決定</button>
    </div>
    
    <div id="historyArea">
      <h3>履歴</h3>
      <ul id="historyList">
        </ul>
    </div>
    
    <button class="reset-button" onclick="initGame()">設定画面に戻る</button>
  </div>

<script>
// JavaScript: ゲームロジック

// ----------------------------------------------
// 定数と変数
// ----------------------------------------------

const HIRAGANA = 'あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん';
const VOWELS = 'あいうえお';
const PLAYER1 = 1; 
const PLAYER2 = 2; // CPUまたは人間2
const TIME_LIMIT = 10;

let currentRule = { start: '', end: '' };
let playerScore = 0;
let cpuScore = 0; // P2のスコアをcpuScoreで管理
let usedWords = [];
let currentRound = 0;
let maxRounds = 5;
let currentPlayer = PLAYER1;
let isGameOver = false;
let opponentType = 'cpu'; // 'cpu' or 'human'
let timerInterval;
let timerSeconds = TIME_LIMIT;

// DOM要素
const settingsArea = document.getElementById('settingsArea');
const gameArea = document.getElementById('gameArea');
const turnIndicator = document.getElementById('turnIndicator');
const timerDisplay = document.getElementById('timerDisplay');
const currentRuleDiv = document.getElementById('currentRule');
const playerScoreSpan = document.getElementById('playerScore');
const cpuScoreSpan = document.getElementById('cpuScore');
const wordInput = document.getElementById('wordInput');
const submitButton = document.getElementById('submitButton');
const historyList = document.getElementById('historyList');
const roundsSelect = document.getElementById('roundsSelect');
const opponentSelect = document.getElementById('opponentSelect');
const p2Label = document.getElementById('p2Label');


// CPUの簡易語彙リスト (3〜6文字)
const CPU_WORDS = [
    "あしあと", "いぬ", "えほん", "おにぎり", "かさ", "きつね", "くつ", "けむり", "こころ",
    "さかな", "すいか", "せんせい", "たいよう", "ちず", "てんき", "ともだち", "とけい",
    "なみだ", "ねこ", "はな", "ふね", "へいわ", "ほし", "まくら", "みず", "むかし",
    "めだま", "もも", "ゆめ", "らくだ", "りんご", "れもん", "ろうそく", "わに", "わかめ", 
    "あかいろ", "きいろ", "あつあつ", "あめんぼ", "いしころ", "おさら", "かめ", "きょうりゅう"
];

// ----------------------------------------------
// 初期化・設定
// ----------------------------------------------

function initGame() {
    // UIを初期設定画面に戻す
    settingsArea.style.display = 'block';
    gameArea.style.display = 'none';
    
    // 変数をリセット
    playerScore = 0;
    cpuScore = 0;
    usedWords = [];
    currentRound = 0;
    isGameOver = false;
    clearTimer();
    updateScore();
    historyList.innerHTML = '';
    
    // P2ラベルを初期化
    p2Label.textContent = 'CPU';
}

function startGame() {
    maxRounds = parseInt(roundsSelect.value);
    opponentType = opponentSelect.value;
    
    if (opponentType === 'human') {
        p2Label.textContent = 'P2';
    } else {
        p2Label.textContent = 'CPU';
    }
    
    // UIをゲーム画面に切り替え
    settingsArea.style.display = 'none';
    gameArea.style.display = 'block';
    
    startNewRound();
    wordInput.disabled = false;
    submitButton.disabled = false;
}

// ----------------------------------------------
// ラウンド管理
// ----------------------------------------------

function startNewRound() {
    if (currentRound >= maxRounds) {
        endGame();
        return;
    }
    currentRound++;
    
    // ランダムなルール生成
    const startChar = HIRAGANA[Math.floor(Math.random() * HIRAGANA.length)];
    const endChar = VOWELS[Math.floor(Math.random() * VOWELS.length)];
    currentRule = { start: startChar, end: endChar };
    
    currentRuleDiv.textContent = `${currentRule.start} → ${currentRule.end} (R${currentRound}/${maxRounds})`;
    
    // P1から開始
    currentPlayer = PLAYER1;
    updateTurnIndicator();
    startTimer();
}

function endGame() {
    isGameOver = true;
    wordInput.disabled = true;
    submitButton.disabled = true;
    clearTimer();
    timerDisplay.textContent = '0';
    
    let resultMessage = '';
    if (playerScore > cpuScore) {
        resultMessage = `ゲーム終了！あなたの勝ちです！ (${playerScore}点 対 ${cpuScore}点)`;
        turnIndicator.style.color = '#e63946';
    } else if (cpuScore > playerScore) {
        const opponentName = opponentType === 'cpu' ? 'CPU' : 'P2';
        resultMessage = `ゲーム終了！${opponentName} の勝ちです！ (${playerScore}点 対 ${cpuScore}点)`;
        turnIndicator.style.color = '#4895ef';
    } else {
        resultMessage = `ゲーム終了！引き分けです！ (${playerScore}点 対 ${cpuScore}点)`;
        turnIndicator.style.color = '#333';
    }
    
    turnIndicator.textContent = resultMessage;
}


// ----------------------------------------------
// タイマー機能
// ----------------------------------------------

function startTimer() {
    clearTimer();
    timerSeconds = TIME_LIMIT;
    timerDisplay.textContent = timerSeconds;
    timerDisplay.style.color = '#1d3557';

    timerInterval = setInterval(() => {
        timerSeconds--;
        timerDisplay.textContent = timerSeconds;

        if (timerSeconds <= 3) {
            timerDisplay.style.color = '#e63946'; // 赤色に
        }

        if (timerSeconds <= 0) {
            clearTimer();
            handleTimeUp();
        }
    }, 1000);
}

function clearTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
}

function handleTimeUp() {
    alert(`${getCurrentPlayerName()}は時間切れです。言葉が見つかりませんでした (0点)！`);
    
    processTurn('時間切れ', currentPlayer, 0); // 0点
    
    // 次のターンへ
    if (!isGameOver) {
        switchTurn();
    }
}

// ----------------------------------------------
// ターン処理
// ----------------------------------------------

function switchTurn() {
    clearTimer();
    
    // P2が人間ならP1へ、P2がCPUならP1へ
    if (currentPlayer === PLAYER2) {
        // P2のターンが終わったら、次のラウンドへ
        startNewRound();
    } else {
        // P1のターンが終わったら、P2のターンへ
        currentPlayer = PLAYER2;
        updateTurnIndicator();

        if (opponentType === 'cpu') {
            submitButton.disabled = true;
            wordInput.disabled = true;
            setTimeout(cpuTurn, 1000); // 1秒後にCPUを動かす
        } else {
            // 人間 vs 人間の場合は次のラウンドへは進まず、P2のターン
            startTimer();
        }
    }
    
    // P1の入力状態をリセット
    if (currentPlayer === PLAYER1 || opponentType === 'human') {
        submitButton.disabled = false;
        wordInput.disabled = false;
    }
}


function getCurrentPlayerName() {
    if (currentPlayer === PLAYER1) return 'あなた (P1)';
    if (opponentType === 'cpu') return 'CPU';
    return 'P2';
}

// ----------------------------------------------
// プレイヤーの入力処理
// ----------------------------------------------

function submitWord() {
    if (isGameOver) return;
    
    // CPU対戦モードでP1のターンでない、または人間対戦モードでP2のターンなのにP1が入力しようとした場合
    if (opponentType === 'cpu' && currentPlayer === PLAYER2) return;

    const word = wordInput.value.trim().toLowerCase().replace(/[^ぁ-んァ-ン]/g, ''); 
    wordInput.value = '';

    if (word.length < 2) {
        alert('言葉は意味の通じる2文字以上で入力してください。');
        return;
    }

    const validation = validateWord(word);
    
    if (validation.valid) {
        clearTimer();
        processTurn(word, currentPlayer, word.length);
        switchTurn();
    } else {
        alert(validation.message);
    }
}

function validateWord(word) {
    // 1. 文字チェック (ひらがな・カタカナであること)
    if (!/^[ぁ-んァ-ン]+$/.test(word)) {
        return { valid: false, message: 'ひらがなまたはカタカナで入力してください。' };
    }
    
    // 2. ルールチェック (頭文字と最後の文字)
    const firstChar = word.charAt(0);
    const lastChar = word.charAt(word.length - 1);
    
    const startRule = currentRule.start;
    const endRule = currentRule.end;
    
    const isStartValid = (firstChar === startRule) || (convertKatakanaToHiragana(firstChar) === startRule);
    const isEndValid = (lastChar === endRule) || (convertKatakanaToHiragana(lastChar) === endRule);

    if (!isStartValid) {
        return { valid: false, message: `頭文字が「${currentRule.start}」ではありません。` };
    }
    if (!isEndValid) {
        return { valid: false, message: `最後の文字が「${currentRule.end}」ではありません。` };
    }

    // 3. 使用済みチェック
    if (usedWords.includes(word)) {
        return { valid: false, message: 'その言葉は既に使用されています。' };
    }
    
    // 4. (簡易的な) 辞書チェック代替として、長すぎる言葉を却下
    if (word.length > 7) {
        return { valid: false, message: '入力できる言葉は7文字までです。辞書に載っている一般的な言葉を使いましょう。' };
    }


    return { valid: true, message: 'OK' };
}

function convertKatakanaToHiragana(char) {
    const katakanaCode = char.charCodeAt(0);
    if (katakanaCode >= 0x30a1 && katakanaCode <= 0x30f6) {
        return String.fromCharCode(katakanaCode - 0x60);
    }
    return char;
}

// ----------------------------------------------
// CPUのターン処理
// ----------------------------------------------

function cpuTurn() {
    if (isGameOver || currentPlayer !== PLAYER2 || opponentType !== 'cpu') return;
    
    updateTurnIndicator('CPUが考えています...', '#4895ef');
    
    let bestWord = '';
    let maxScore = -1;
    
    const startRule = currentRule.start;
    const endRule = currentRule.end;

    for (const word of CPU_WORDS) {
        const firstChar = word.charAt(0);
        const lastChar = word.charAt(word.length - 1);
        
        const isStartValid = (firstChar === startRule);
        const isEndValid = (lastChar === endRule);
        const isUnused = !usedWords.includes(word);

        if (isStartValid && isEndValid && isUnused) {
            const score = word.length;
            if (score > maxScore) {
                maxScore = score;
                bestWord = word;
            }
        }
    }
    
    // 思考時間（タイマー代わり）
    setTimeout(() => {
        let score = 0;
        let wordResult = '';
        
        if (bestWord) {
            score = bestWord.length;
            wordResult = bestWord;
        } else {
            wordResult = 'ギブアップ';
        }
        
        processTurn(wordResult, PLAYER2, score);
        
        // P2ターン終了
        switchTurn();
    }, 2000); // CPUは2秒で回答
}


// ----------------------------------------------
// ターン終了後の共通処理
// ----------------------------------------------

function processTurn(word, player, score) {
    
    // スコアと履歴の更新
    if (player === PLAYER1) {
        playerScore += score;
        if (score > 0) usedWords.push(word);
        addHistory(word, score, 'player1-entry');
    } else {
        cpuScore += score;
        if (score > 0) usedWords.push(word);
        addHistory(word, score, 'player2-entry');
    }
    
    updateScore();
}

function updateScore() {
    playerScoreSpan.textContent = playerScore;
    cpuScoreSpan.textContent = cpuScore;
}

function updateTurnIndicator(message = '', color = '') {
    if (message) {
        turnIndicator.textContent = message;
    } else {
        turnIndicator.textContent = `${getCurrentPlayerName()}の番です`;
    }

    if (color) {
        turnIndicator.style.color = color;
    } else {
        turnIndicator.style.color = (currentPlayer === PLAYER1) ? '#e63946' : '#4895ef';
    }
}

function addHistory(word, score, className) {
    const listItem = document.createElement('li');
    let playerLabel = '';
    if (className === 'player1-entry') playerLabel = 'P1';
    else if (opponentType === 'cpu') playerLabel = 'CPU';
    else playerLabel = 'P2';
    
    if (word === '時間切れ' || word === 'ギブアップ') {
        listItem.textContent = `${playerLabel}: ${word} (0点)`;
    } else {
        listItem.textContent = `${playerLabel}: 「${word}」 (${score}点)`;
    }
    
    listItem.classList.add(className);
    historyList.prepend(listItem);
}


// ----------------------------------------------
// ゲーム開始
// ----------------------------------------------
initGame();
</script>

</body>
</html>
