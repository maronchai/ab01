<!DOCTYPE html>
<html>
<head>
<title>あたまおしりゲーム (メルヘン・エディション)</title>
<style>
  /* ---------------------- 基本スタイル ---------------------- */
  @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');
  
  body {
    font-family: 'M PLUS Rounded 1c', 'Arial', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #fce4ec; /* パステルピンクの背景 */
    padding: 20px;
    color: #30445C; /* 濃い茶色/ネイビーの文字 */
  }
  
  h2 {
    color: #E63946;
    margin-bottom: 15px;
    text-shadow: 1px 1px 2px #fff;
  }

  /* ---------------------- 設定・ゲームエリア ---------------------- */
  #settingsArea, #gameArea {
    width: 80%;
    max-width: 500px;
    background-color: #fff;
    padding: 20px 25px;
    border-radius: 20px; /* 角を丸く */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    border: 3px solid #FFC0CB; /* ピンクの縁取り */
  }

  .setting-group {
    margin-bottom: 15px;
  }
  .setting-group label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
  }
  
  select {
    padding: 8px;
    border-radius: 8px;
    border: 2px solid #A8DAD6; /* ミントグリーン */
    font-family: 'M PLUS Rounded 1c', sans-serif;
  }

  #startButton {
    padding: 10px 30px;
    font-size: 18px;
    background-color: #E63946;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.2s;
    box-shadow: 0 4px #c9303c;
  }
  #startButton:active {
    box-shadow: 0 0 #c9303c;
    transform: translateY(4px);
  }
  
  /* ---------------------- ターン・タイマー表示 ---------------------- */
  #turnIndicator {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
    text-align: center;
  }

  #timerDisplay {
    font-size: 48px;
    font-weight: 900;
    margin-bottom: 10px;
    text-align: center;
    text-shadow: 2px 2px #fff;
    /* キラキラ装飾の準備 */
    position: relative;
    padding: 5px;
  }
  
  /* ルール表示 - フキダシ風 */
  #currentRule {
    font-size: 32px;
    font-weight: 900;
    color: #4895EF; 
    margin: 15px 0;
    text-align: center;
    background-color: #FFFACD; /* ライトイエロー */
    padding: 10px 20px;
    border-radius: 20px;
    border: 3px dashed #FFC0CB;
  }
  
  /* ---------------------- スコアボード ---------------------- */
  #scoreBoard {
    display: flex;
    justify-content: space-around;
    width: 100%;
    margin-bottom: 20px;
  }

  .score-item {
    padding: 10px 15px;
    border-radius: 15px;
    background-color: #F1FAEE;
    border: 2px solid #A8DAD6;
    flex: 1;
    margin: 0 5px;
    text-align: center;
    font-weight: bold;
  }
  
  .score-item span {
      font-size: 24px;
      margin-left: 5px;
      color: #E63946;
  }

  /* ---------------------- 入力エリア ---------------------- */
  #wordInput {
    padding: 12px;
    font-size: 16px;
    border: 2px solid #FFC0CB; 
    border-radius: 10px;
    flex-grow: 1;
    font-family: 'M PLUS Rounded 1c', sans-serif;
  }

  #submitButton {
    padding: 12px 20px;
    font-size: 16px;
    background-color: #4895EF; /* ベビーブルー */
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  /* ---------------------- 履歴エリア ---------------------- */
  #historyList {
    list-style: none;
    padding: 0;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 10px;
    background-color: #ffffff;
  }

  #historyList li {
    padding: 7px 5px;
    border-bottom: 1px dotted #ccc;
    font-size: 16px;
    line-height: 1.4;
  }
  
  .player1-entry { color: #E63946; } 
  .player2-entry { color: #4895EF; } 
  
  .reset-button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    background-color: #A8DAD6;
    color: #30445C;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }
</style>
</head>
<body>

  <h2>あたまおしりゲーム </h2>

  <div id="settingsArea">
    <div class="setting-group">
      <label for="roundsSelect">問題の出題回数 (総ラウンド):</label>
      <select id="roundsSelect">
        <option value="5">5 ラウンド</option>
        <option value="10">10 ラウンド</option>
        <option value="15">15 ラウンド</option>
      </select>
    </div>
    <div class="setting-group">
      <label for="opponentSelect">対戦相手選択:</label>
      <select id="opponentSelect">
        <option value="cpu">CPU (くまさん) と対戦</option>
        <option value="human">2人で対戦 (人間 vs 人間)</option>
      </select>
    </div>
    <div class="setting-group">
      <label for="timeLimitSelect">ターン制限時間選択:</label>
      <select id="timeLimitSelect">
        <option value="10">10 秒</option>
        <option value="15">15 秒</option>
        <option value="20">20 秒</option>
      </select>
    </div>
    <button id="startButton" onclick="startGame()">ゲームスタート</button>
  </div>

  <div id="gameArea">
    <div id="turnIndicator">ゲームを開始してください</div>
    <div id="timerDisplay">5</div>
    <div id="currentRule">？ → ？</div>
  
    <div id="scoreBoard">
      <div class="score-item"> P1 (あなた): <span id="playerScore">0</span></div>
      <div class="score-item"><span id="p2Icon"></span> <span id="p2Label">CPU</span> (P2): <span id="cpuScore">0</span></div>
    </div>

    <div id="inputArea">
      <input type="text" id="wordInput" placeholder="言葉を入力 (ひらがな/カタカナ)">
      <button id="submitButton" onclick="submitWord()">決定</button>
    </div>
    
    <div id="historyArea">
      <h3> 履歴</h3>
      <ul id="historyList">
        </ul>
    </div>
    
    <button class="reset-button" onclick="initGame()">設定画面に戻る</button>
  </div>

<script>
// JavaScript: ゲームロジック

// ----------------------------------------------
// 定数と変数
// ----------------------------------------------

const HIRAGANA = 'あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん';
const VOWELS = 'あいうえお';
const PLAYER1 = 1; 
const PLAYER2 = 2; 
const PREP_TIME = 5; // 準備時間 5秒

let currentRule = { start: '', end: '' };
let playerScore = 0;
let cpuScore = 0; 
let usedWords = [];
let roundCounter = 0; // ルール（問題）が変わった回数
let maxRounds = 5; // 最大出題回数
let currentPlayer = PLAYER1;
let isGameOver = false;
let opponentType = 'cpu'; 
let timerLimit = 10; 
let timerInterval;
let timerSeconds = 0;
let isPreparing = false;

// DOM要素
const settingsArea = document.getElementById('settingsArea');
const gameArea = document.getElementById('gameArea');
const turnIndicator = document.getElementById('turnIndicator');
const timerDisplay = document.getElementById('timerDisplay');
const currentRuleDiv = document.getElementById('currentRule');
const playerScoreSpan = document.getElementById('playerScore');
const cpuScoreSpan = document.getElementById('cpuScore');
const wordInput = document.getElementById('wordInput');
const submitButton = document.getElementById('submitButton');
const historyList = document.getElementById('historyList');
const roundsSelect = document.getElementById('roundsSelect');
const opponentSelect = document.getElementById('opponentSelect');
const timeLimitSelect = document.getElementById('timeLimitSelect');
const p2Label = document.getElementById('p2Label');
const p2Icon = document.getElementById('p2Icon');

// CPUの簡易語彙リスト (3〜6文字)
const CPU_WORDS = [
    "あしあと", "いぬ", "えほん", "おにぎり", "かさ", "きつね", "くつ", "けむり", "こころ",
    "さかな", "すいか", "せんせい", "たいよう", "ちず", "てんき", "ともだち", "とけい",
    "なみだ", "ねこ", "はな", "ふね", "へいわ", "ほし", "まくら", "みず", "むかし",
    "めだま", "もも", "ゆめ", "らくだ", "りんご", "れもん", "ろうそく", "わに", "わかめ", 
    "あかいろ", "きいろ", "あつあつ", "あめんぼ", "いしころ", "おさら", "かめ", "きょうりゅう"
];

// ----------------------------------------------
// Enterキー機能の追加
// ----------------------------------------------

document.addEventListener('DOMContentLoaded', () => {
    wordInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); 
            if (!submitButton.disabled) {
                submitWord();
            }
        }
    });
});

// ----------------------------------------------
// 初期化・設定
// ----------------------------------------------

function initGame() {
    settingsArea.style.display = 'block';
    gameArea.style.display = 'none';
    
    playerScore = 0;
    cpuScore = 0;
    usedWords = [];
    roundCounter = 0;
    isGameOver = false;
    clearTimer();
    timerDisplay.textContent = '0';
    updateScore();
    historyList.innerHTML = '';
    wordInput.disabled = true;
    submitButton.disabled = true;
    
    p2Label.textContent = 'CPU';
    p2Icon.textContent = '';
    currentRuleDiv.textContent = '？ → ？';
}

function startGame() {
    maxRounds = parseInt(roundsSelect.value);
    opponentType = opponentSelect.value;
    timerLimit = parseInt(timeLimitSelect.value);
    
    if (opponentType === 'human') {
        p2Label.textContent = 'P2';
        p2Icon.textContent = ''; // 2Pも可愛いくまさんアイコンで
    } else {
        p2Label.textContent = 'CPU';
        p2Icon.textContent = '';
    }
    
    settingsArea.style.display = 'none';
    gameArea.style.display = 'block';
    
    currentPlayer = PLAYER1;
    startPreparation();
}

// ----------------------------------------------
// 準備カウントダウン
// ----------------------------------------------

function startPreparation() {
    if (isGameOver) return;
    
    isPreparing = true;
    clearTimer();
    wordInput.disabled = true;
    submitButton.disabled = true;

    let isNewRound = false;
    if (currentPlayer === PLAYER1) {
        roundCounter++;
        isNewRound = true;
    }
    
    if (roundCounter > maxRounds) {
        endGame();
        return;
    }

    // 新しいルール生成
    const startChar = HIRAGANA[Math.floor(Math.random() * HIRAGANA.length)];
    const endChar = VOWELS[Math.floor(Math.random() * VOWELS.length)];
    currentRule = { start: startChar, end: endChar };
    
    const roundText = `(R${roundCounter}/${maxRounds})`;
    
    // UIメッセージ
    if (isNewRound) {
        currentRuleDiv.textContent = ` 新しい問題開始 ${roundText}`;
        updateTurnIndicator(`P1 、心の準備を！`, '#FF69B4'); /* ショッキングピンク */
    } else {
        currentRuleDiv.textContent = ` ターン切り替え ${roundText}`;
        updateTurnIndicator(`${getCurrentPlayerIcon()}、心の準備を！`, '#9370DB'); /* ラベンダー */
    }

    timerSeconds = PREP_TIME;
    timerDisplay.textContent = ` 準備: ${timerSeconds}`;
    timerDisplay.style.color = '#30445C'; /* ネイビー */

    timerInterval = setInterval(() => {
        timerSeconds--;
        timerDisplay.textContent = ` 準備: ${timerSeconds}`;
        
        if (timerSeconds <= 0) {
            clearTimer();
            isPreparing = false;
            startTurn();
        }
    }, 1000);
}

// ----------------------------------------------
// ターン開始・タイマー機能
// ----------------------------------------------

function startTurn() {
    if (isGameOver) return;
    
    clearTimer();
    wordInput.disabled = false;
    submitButton.disabled = false;
    wordInput.focus();

    currentRuleDiv.textContent = `${currentRule.start} → ${currentRule.end} (R${roundCounter}/${maxRounds})`;

    if (currentPlayer === PLAYER1 || opponentType === 'human') {
        updateTurnIndicator();
        startTimer();
    } 
    else if (opponentType === 'cpu') {
        updateTurnIndicator(' CPUが考えています...', '#4895EF');
        submitButton.disabled = true;
        wordInput.disabled = true;
        setTimeout(cpuTurn, 2000); // 2秒後にCPUを動かす
    }
}


function startTimer() {
    clearTimer();
    timerSeconds = timerLimit;
    timerDisplay.textContent = `${timerSeconds}s `;
    timerDisplay.style.color = '#1d3557';

    timerInterval = setInterval(() => {
        timerSeconds--;
        timerDisplay.textContent = `${timerSeconds}s `;

        if (timerSeconds <= 3) {
            timerDisplay.style.color = '#E63946'; 
            timerDisplay.textContent = `${timerSeconds}s `;
        } else {
             timerDisplay.style.color = '#1d3557';
        }

        if (timerSeconds <= 0) {
            clearTimer();
            handleTimeUp();
        }
    }, 1000);
}

function clearTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function handleTimeUp() {
    alert(`${getCurrentPlayerIcon()} ${getCurrentPlayerName()}は時間切れです。言葉が見つかりませんでした (0点)！`);
    
    processTurn('時間切れ', currentPlayer, 0); 
    
    if (!isGameOver) {
        switchTurn();
    }
}

// ----------------------------------------------
// ターン終了後の処理
// ----------------------------------------------

function switchTurn() {
    clearTimer();
    
    if (currentPlayer === PLAYER2) {
        currentPlayer = PLAYER1;
    } else {
        currentPlayer = PLAYER2;
    }
    
    // CPU戦の場合はP2->P1で準備時間、P1->P2で即ターン開始
    // 2人戦の場合は常に準備時間を挟む
    if (opponentType === 'human' || currentPlayer === PLAYER1) {
        startPreparation();
    } else {
        startTurn(); 
    }
}


function getCurrentPlayerName() {
    if (currentPlayer === PLAYER1) return 'あなた (P1)';
    if (opponentType === 'cpu') return 'CPU';
    return 'P2';
}

function getCurrentPlayerIcon() {
    return (currentPlayer === PLAYER1) ? '' : '';
}

// ----------------------------------------------
// プレイヤーの入力処理
// ----------------------------------------------

function submitWord() {
    if (submitButton.disabled || isGameOver || isPreparing) return;
    if (opponentType === 'cpu' && currentPlayer === PLAYER2) return;

    const word = wordInput.value.trim().toLowerCase().replace(/[^ぁ-んァ-ン]/g, ''); 
    wordInput.value = '';

    if (word.length < 2) {
        alert('言葉は意味の通じる2文字以上で入力してください。');
        return;
    }

    const validation = validateWord(word);
    
    if (validation.valid) {
        processTurn(word, currentPlayer, word.length);
        switchTurn();
    } else {
        alert(validation.message);
    }
}

function validateWord(word) {
    if (!/^[ぁ-んァ-ン]+$/.test(word)) {
        return { valid: false, message: 'ひらがなまたはカタカナで入力してください。' };
    }
    
    const firstChar = word.charAt(0);
    const lastChar = word.charAt(word.length - 1);
    
    const startRule = currentRule.start;
    const endRule = currentRule.end;
    
    const isStartValid = (firstChar === startRule) || (convertKatakanaToHiragana(firstChar) === startRule);
    const isEndValid = (lastChar === endRule) || (convertKatakanaToHiragana(lastChar) === endRule);

    if (!isStartValid) {
        return { valid: false, message: `頭文字が「${currentRule.start}」ではありません。` };
    }
    if (!isEndValid) {
        return { valid: false, message: `最後の文字が「${currentRule.end}」ではありません。` };
    }

    if (usedWords.includes(word)) {
        return { valid: false, message: 'その言葉は既に使用されています。' };
    }
    
    if (word.length > 7) {
        return { valid: false, message: '入力できる言葉は7文字までです。一般的な言葉を使いましょう。' };
    }

    return { valid: true, message: 'OK' };
}

function convertKatakanaToHiragana(char) {
    const katakanaCode = char.charCodeAt(0);
    if (katakanaCode >= 0x30a1 && katakanaCode <= 0x30f6) {
        return String.fromCharCode(katakanaCode - 0x60);
    }
    return char;
}

// ----------------------------------------------
// CPUのターン処理
// ----------------------------------------------

function cpuTurn() {
    if (isGameOver || currentPlayer !== PLAYER2 || opponentType !== 'cpu') return;
    
    let bestWord = '';
    let maxScore = -1;
    
    const startRule = currentRule.start;
    const endRule = currentRule.end;

    for (const word of CPU_WORDS) {
        const firstChar = word.charAt(0);
        const lastChar = word.charAt(word.length - 1);
        
        const isStartValid = (firstChar === startRule);
        const isEndValid = (lastChar === endRule);
        const isUnused = !usedWords.includes(word);

        if (isStartValid && isEndValid && isUnused) {
            const score = word.length;
            if (score > maxScore) {
                maxScore = score;
                bestWord = word;
            }
        }
    }
    
    setTimeout(() => {
        let score = 0;
        let wordResult = '';
        
        if (bestWord) {
            score = bestWord.length;
            wordResult = bestWord;
        } else {
            wordResult = 'ギブアップ';
        }
        
        processTurn(wordResult, PLAYER2, score);
        
        switchTurn();
    }, 2000); 
}


// ----------------------------------------------
// ターン終了後の共通処理
// ----------------------------------------------

function processTurn(word, player, score) {
    
    if (player === PLAYER1) {
        playerScore += score;
        if (score > 0) usedWords.push(word);
        addHistory(word, score, 'player1-entry');
    } else {
        cpuScore += score;
        if (score > 0) usedWords.push(word);
        addHistory(word, score, 'player2-entry');
    }
    
    updateScore();
}

function updateScore() {
    playerScoreSpan.textContent = playerScore;
    cpuScoreSpan.textContent = cpuScore;
}

function updateTurnIndicator(message = '', color = '') {
    const icon = getCurrentPlayerIcon();

    if (message) {
        turnIndicator.textContent = message;
    } else {
        turnIndicator.textContent = `${icon} ${getCurrentPlayerName()}の番です！`;
    }

    if (color) {
        turnIndicator.style.color = color;
    } else {
        turnIndicator.style.color = (currentPlayer === PLAYER1) ? '#E63946' : '#4895EF';
    }
}

function addHistory(word, score, className) {
    const listItem = document.createElement('li');
    let playerLabel = (className === 'player1-entry') ? ' P1' : ' P2';
    
    const roundInfo = `(R${roundCounter})`;

    if (word === '時間切れ' || word === 'ギブアップ') {
        listItem.textContent = `${playerLabel}: ${word}  (0点) ${roundInfo}`;
    } else {
        listItem.textContent = `${playerLabel}: 「${word}」  (${score}点) ${roundInfo}`;
    }
    
    listItem.classList.add(className);
    historyList.prepend(listItem);
}


// ----------------------------------------------
// ゲーム終了処理
// ----------------------------------------------

function endGame() {
    isGameOver = true;
    wordInput.disabled = true;
    submitButton.disabled = true;
    clearTimer();
    timerDisplay.textContent = '0';
    
    let resultMessage = '';
    const p2Name = opponentType === 'cpu' ? ' CPU' : ' P2';
    
    if (playerScore > cpuScore) {
        resultMessage = ` ゲーム終了！ P1 (あなた) の勝ちです！ (${playerScore}点 対 ${cpuScore}点)`;
        turnIndicator.style.color = '#FF69B4'; 
    } else if (cpuScore > playerScore) {
        resultMessage = ` ゲーム終了！${p2Name} の勝ちです！ (${playerScore}点 対 ${cpuScore}点)`;
        turnIndicator.style.color = '#4895EF';
    } else {
        resultMessage = ` ゲーム終了！引き分けです！ (${playerScore}点 対 ${cpuScore}点)`;
        turnIndicator.style.color = '#30445C';
    }
    
    turnIndicator.textContent = resultMessage;
}


// ----------------------------------------------
// ゲーム開始
// ----------------------------------------------
initGame();
</script>

</body>
</html>
